# cgroups
## Generalities :

Each subsystem has a hierarchy (tree) for CPU, Memory and Block I/O(blkio)

Hierarchies are independent (memory and cpu can be different)

Each process is in a node in each hierarchy (different dimension and axis)
Each hierarchy starts with 1 node(the root)
Each node = group of processes sharing the same resource. 

## Cgroups:
- __Memory cgroup:__ 
    - Accounting: 
	    - Keeps track of pages used by each group:
	    - Each page is "charged" to a group
	    - Pages can be shared across multiple groups
			
	- Limits:
		- Each group can have its own limits (limits are optional). Two types 
			- Soft limits - they influence reclaim under memory pressure
			- Hard limits - it will trigger a per-group OOM killer
	
		- Limits can be set for different kinds of memory 
			- Physical memory
			- Kernel memory
		- Details :
			- Each time the kernel gives a page to a process, or takes it away, it updates the counters
			- This adds some overhead
			- This cannot be enabled/disabled per process (at boot time)
			- When multiple groups use the same page, only the first one is "charged".(if it stops using it, the charge is moved to another group)
- __CPU Cgroup:__
	- Keeps track of :
		- user/system CPU time 
		- Usage per CPU
    - Allows to set weights

- __Blkio cgroups(Block IO):__
	- Keeps track of I/Os for each group
		- Per block device 
		- Read vs write
		- Sync vs async
	- Set throttle(limits) for each group
		- Pre block device
		- Read vs write
		- Ops vs bytes
	- Set relative weights for each group
- __Net_cls and net_prio cgroup:__
	- Automatically set traffic class or priority, for traffic generated by processes in the group
	- Net_cls will assign traffic to a class
		- Class then has to be matched with tc/iptables, otherwise traffic just flows normally.
    - Net_prio will assign traffic to a priority (priorities are used by queuing disciplines )

- __Device cgroups:__
	- Controls what the group can do on device nodes
	- Permissions include read/write/mknod
	- Typical use:
		- Allow /dev/
		- Deny everything else
	- A few interesting nodes:
		- /dev/net/tun (network interface manipulation)
		- /dev/fuse (filesystems in user space)
		- /dev/kvm (Vms in containers)
		- /dev/dri(GPU)
- __Freezer cgroups:__
	- Allows to freeze/thaw a group of processes
	- Similar to SIGSTOP/SIGCOUNT
	- Clusture batch scheduling 
    - Process migration



# More
	
- PID 1 is placed at the root of each hierarchy
- New processes start in their parent's groups
- Groups are materialized by pseudo-fs  (/sys/fs/cgroup)
- Groups are created by mkdir in the pseudo-fs (mkdir /sys/fs/cgroup/memory/xyzgroup/subcgroup)
- To move a process:	Echo $PID > /sys/fs/cgroup/…/tasks
	
## OOM Killer :

When the kernel terminates random processes because something unrelated ate all the memory in the system. 
OOM-notifier come into picture. 
- When hard limit is exceeded: freeze all processes in the group.
- Notify user space 
- We can kill processes, raise limits, migrate containers…
- When we're in the clear again, unfreeze the group. 
